---
layout: post
title: "Lesson 06: Create Plots with Multiple Panels, Grouped by Time Using GGPLOT
Facets"
date:   2015-10-19
authors: [Megan A. Jones, Marisa Guarinello, Courtney Soderberg]
contributors: [Leah Wasser]
dateCreated: 2015-10-22
lastModified: `r format(Sys.time(), "%Y-%m-%d")`
packagesLibraries: [ggplot2, scales, gridExtra, grid, dplyr, reshape2]
category:  
tags: [spatio-temporal, time-series, phenology]
mainTag: time-series
description: "This lesson teaches how to plot subsetted time series data using
the `facets()` function (e.g., plot by season) and to plot time series data with
NDVI."
code1: TS06-Facets-And-NDVI-Plotting-In-R.R
image:
  feature: NEONCarpentryHeader_2.png
  credit: A collaboration between the National Ecological Observatory Network (NEON) and Data Carpentry
  creditlink: http://www.neoninc.org
permalink: /R/Time-Series-Plot-Facets-NDVI
comments: false
---

{% include _toc.html %}

##About
This lesson teaches how to plot subsetted time series data using
the `facets()` function (e.g., plot by season) and to plot time series data with
NDVI.

**R Skill Level:** Intermediate - you've got the basics of `R` down.

<div id="objectives" markdown="1">

###Goals / Objectives
After completing this activity, you will:

 * Know how to use `facets()` in the ggplot2 package.
 * Be able to combine different types of data into one plot.

##Things Youâ€™ll Need To Complete This Lesson
To complete this lesson: you will need the most current version of R, and 
preferably RStudio, loaded on your computer.

###Install R Packages
* **ggplot2:** `install.packages("ggplot2")`
* **scales:** `install.packages("scales")`
* **gridExtra:** `install.packages("gridExtra")`
* **grid:** `install.packages("grid")`
* **dplyr:** `install.packages("dplyr")`
* **reshape2:** `install.packages("reshape2")`

* [More on Packages in R - Adapted from Software Carpentry.]({{site.baseurl}}R/Packages-In-R/)

###Data to Download
{% include/dataSubsets/_data_Met-Time-Series.html %}

****

{% include/_greyBox-wd-rscript.html %}

**Tabular Time Series Lesson Series:** This lesson is part of a lesson series on 
[tabular time series data in R ]({{ site.baseurl }}self-paced-tutorials/tabular-time-series). 
It is also part of a larger 
[spatio-temporal Data Carpentry workshop ]({{ site.baseurl }}self-paced-tutorials/spatio-temporal-workshop)
that includes working with
[raster data in R ]({{ site.baseurl }}self-paced-tutorials/spatial-raster-series) 
and  
[vector data in R ]({{ site.baseurl }}self-paced-tutorials/spatial-vector-series).

****

##Skills Needed
This lessons assumes familiarity with both the `dplyr` package and `ggplot()` in
the `ggplot2` package.  If you are not comfortable with either of these we
recommend starting with the
[Subset & Manipulate Time Series Data with dplyr lesson]({{site.baseurl}}/R/Time-Series-Subset-dplyr/ "Learn dplyr") 
and the 
[Plotting Time Series with ggplot in R lesson]({{site.baseurl}}/R/Time-Series-Plot-ggplot/ "Learn ggplot")  
respectively, to gain familiarity.

</div>

#Plotting Subsetted Data Using Facets
 
In this lesson we will learn how to create a panel of indivual plots - known as
facets in `ggplot2`. Each plot represents a particular `data_frame` time-series 
subset - for example year or season.

###Load the Data
We will use the daily micro-meteorology data for 2009-2011 from the Harvard
Forest. If you do not have this data loaded into an `R` `data_frame`, please 
load them, and convert date-time columns to a date-time class now.

```{r load-data}
#Remember it is good coding technique to add additional libraries to the top of
  #your script 
library(lubridate) #for working with dates
library(ggplot2)  #for creating graphs
library(scales)   #to access breaks/formatting functions
library(gridExtra) #for arranging plots
library(grid)   #for arrangeing plots
library(dplyr)  #for subsetting by season

#set working directory to ensure R can find the file we wish to import
#setwd("working-dir-path-here")

#daily HARV met data, 2009-2011
harMetDaily.09.11 <- read.csv(file="NEON-DS-Met-Time-Series/HARV/FisherTower-Met/Met_HARV_Daily_2009_2011.csv",
                     stringsAsFactors = FALSE)

#covert date to POSIXct date-time class
harMetDaily.09.11$date <- as.POSIXct(harMetDaily.09.11$date)

#monthly HARV temperature data, 2009-2011
#harTemp.monthly.09.11<-read.csv(file="NEON-DS-Met-Time-Series/HARV/FisherTower-Met/Temp_HARV_Monthly_09_11.csv",
#                                stringsAsFactors=FALSE)

#convert datetime from chr to datetime class & rename date for clarification
#harTemp.monthly.09.11$date <- as.POSIXct(harTemp.monthly.09.11$datetime)
```

##GGPLOT Facets

Facets allow us to plot subsets of data in one cleanly organized panel. We use
 `facet_grid()` to create a plot of a particular variable subsetted by a particular
 "group".
 
Let's plot air temperature as we did previously. We will name the `ggplot`
object `AirTempDaily`.

```{r plot-airt }

AirTempDaily <- ggplot(harMetDaily.09.11, aes(date, airt)) +
           geom_point() +
           ggtitle("Daily Air Temperature NEON Harvard Forest\n 2009-2011") +
            xlab("Date") + ylab("Temperature (C)") +
            scale_x_datetime(labels=date_format ("%m-%y"))+
           theme(plot.title = element_text(lineheight=.8, face="bold",
                 size = 20)) +
           theme(text = element_text(size=18))

AirTempDaily
```
 
This plot tells us a lot about the annual increase and decrease of temperature
at the NEON Harvard Forest field site. However, what is we wanted to plot each
year's worth of data individually?

If we use the `facet()` element in `ggplot`, we can create facets or a panel of 
plots that are grouped by a particular category or time period. To create a 
a plot for each year, we will first need a year column in our data to use a subset 
factor. We created a year column did this in the 
[{{site.baseurl}}R/Time-Series-Subset-dplyr/](dplyr subset timeseries lesson)
using the `year` function in the `lubridate` package.

 
```{r plot-by-year}
#add year column to daily values
harMetDaily.09.11$year <- year(harMetDaily.09.11$date)

#view year column head and tail
head(harMetDaily.09.11$year)
tail(harMetDaily.09.11$year)

```


## Facet by Year
Once we have a column that can be used to group or subset our data, we can 
create a facetted plot - plotting each year's worth of data in 
an individual, named panel.

```{r plot-facet-year }
#run this code to plot the same plot as before but with one plot per season
AirTempDaily + facet_grid(. ~ year)
```

Oops - what happened? The plot did not render because we added the `year` column
after creating the `ggplot` object `AirTempDaily`. Let's rerun the ggplot code
to ensure our newly added column is recognized.

```{r plot-facet-year-2}
AirTempDaily <- ggplot(harMetDaily.09.11, aes(date, airt)) +
           geom_point() +
           ggtitle("Daily Air Temperature NEON Harvard Forest\n 2009-2011") +
            xlab("Date") + ylab("Temperature (C)") +
            scale_x_datetime(labels=date_format ("%m-%y"))+
           theme(plot.title = element_text(lineheight=.8, face="bold",
                 size = 20)) +
           theme(text = element_text(size=18))

#facet plot by year
AirTempDaily + facet_grid(. ~ year)
```

The faceted plot is interesting, however the x-axis on each plot is month-day-year.
This means that the data for 2009 is on the left end of the plot and the data for
2011 is on the right end (the end of the x axis) of the 2011 plot. Our plots might be 
easier to compare visually, if the days were julian days rather than date. 

```{r plot-precip-jd }

AirTempDaily_jd <- ggplot(harMetDaily.09.11, aes(jd, airt)) +
           geom_point() +
           ggtitle("Daily Precipitation Harvard Forest\n 2009-2011") +
            xlab("Julian Day") + ylab("Temperature (C)") +
           theme(plot.title = element_text(lineheight=.8, face="bold",
                 size = 20)) +
           theme(text = element_text(size=18))

#create faceted panel
AirTempDaily_jd + facet_grid(. ~ year)

```

Using Julian Day, our plots are visually easier to compare. Arranging our plots 
this way, side by side, allows us to quickly scan for differences
along the Y axis. Notice any differences in min vs max air temperature across the 
three years?

##Arrange Facets

We can rearrange the facets in different ways, too.

```{r rearrange-facets }

#move labels to the RIGHT and stack all plots
AirTempDaily_jd + facet_grid(year ~ .)


```

If we use `facet_wrap` we can specify the number of columns

```{r rearrange-facets-columns }

#add columns
AirTempDaily_jd + facet_wrap(~year, ncol = 2)


```

##Graph Two Variables on One Plot
Next, let's explore the relationship between two variables - air temperature
and soil temperature. We might expect soil temperature to fluctuate with
changes in air temperature over time.  

We will use `ggplot()` to plot `airt` and `s10t` (soil temperature
10 cm below the ground). 

```{r plot-airt-soilt }

airSoilTemp_Plot <- ggplot(harMetDaily.09.11, aes(airt, s10t)) +
           geom_point() +
           ggtitle("Air vs. Soil Temperature NEON Harvard Forest Field Site\n 2009-2011") +
           xlab("Air Temperature (C)") + ylab("Soil Temperature (C)") +
           theme(plot.title = element_text(lineheight=.8, face="bold",
                 size = 20)) +
           theme(text = element_text(size=18))

airSoilTemp_Plot

```

The plot above suggests a relationship between the air and soil temperature as
we might expect. However, it clumps all three years worth of data into one plot. 
Let's create a stacked facetted plot of air vs. soil temperature grouped by year.

Lucky for us, we can do this quickly with one line of code - reusing the plot we
created above.

```{r faceted-temp-plots }
#create faceted panel
airSoilTemp_Plot + facet_grid(year ~ .)
```

Have a close look at the data. Are there any noticable min / max temperature 
differences between the three years?

<div id="challenge" markdown="1">

##Challenge

Create a facetted plot of air temperature vs soil temperature by MONTH rather 
than year.

* HINT: To create this plot, you will want to add a month column to our data_frame.
We can use lubridate `month` in the same way we used `year` to add a year column. 

</div>

```{r challenge-answer-temp-month, echo=FALSE }

#add month column to daily values
harMetDaily.09.11$month <- month(harMetDaily.09.11$date)

#recreate plot
airSoilTemp_Plot <- ggplot(harMetDaily.09.11, aes(airt, s10t)) +
           geom_point() +
           ggtitle("Air vs. Soil Temperature NEON Harvard Forest Field Site\n 2009-2011") +
           xlab("Air Temperature (C)") + ylab("Soil Temperature (C)") +
           theme(plot.title = element_text(lineheight=.8, face="bold",
                 size = 20)) +
           theme(text = element_text(size=18))

#create faceted panel
airSoilTemp_Plot + facet_wrap(~month, nc=3)

```

##Facetted Plots & Categorical Groups

In the challenge above, we grouped our data by MONTH - specificed by a numeric
value between 1 (January) and 12 (December). However, what if we wanted to 
organize our plots using a categorical (character) group such as month NAME?
Let's do that next.

If we want to group our data by month NAME, we first need to create a month name
column in our `data_frame`. We can create this column using the following syntax:

`format(harMetDaily.09.11$date,"%B")`

Which tells `R` to extract the month name (`%B`) from the date field.

```{r extract-month-name }
#add text month name column
harMetDaily.09.11$month_name <- format(harMetDaily.09.11$date,"%B")

#view head and tail
head(harMetDaily.09.11$month_name)
tail(harMetDaily.09.11$month_name)

#recreate plot
airSoilTemp_Plot <- ggplot(harMetDaily.09.11, aes(airt, s10t)) +
           geom_point() +
           ggtitle("Air vs. Soil Temperature NEON Harvard Forest Field Site\n 2009-2011") +
            xlab("Air Temperature (C)") + ylab("Soil Temperature (C)") +
           theme(plot.title = element_text(lineheight=.8, face="bold",
                 size = 20)) +
           theme(text = element_text(size=18))

#create faceted panel
airSoilTemp_Plot + facet_wrap(~month_name, nc=3)

```

Great! We've created a nice set of plots by month. However, what is the order
or the plots? It looks like `R` is ordering things alphabetically yet we know
that months are ordinal not character strings. To account for order, we can 
reassign the `month_name` field to a `factor`. This will allow us to specify
an order to each factor "level" (each month is a level).

The syntax for this operation is 

1. turn field into a factor: `factor(fieldName) `
2. designate the `levels` using a list `c(level1, level2, level3)`

In our case, each level will be a month.

```{r factor }
#order the factors
harMetDaily.09.11$month_name = factor(harMetDaily.09.11$month_name, 
                                      levels=c('January','February','March',
                                               'April','May','June','July',
                                               'August','September','October',
                                               'November','December'))
```

Once we have specified the factor column and its associated levels, we can plot 
again. Remember, that because we have modified a column in our `data_frame`, we
need to rerun our `ggplot` code.

```{r plot-by-month-levels }

#recreate plot
airSoilTemp_Plot <- ggplot(harMetDaily.09.11, aes(airt, s10t)) +
           geom_point() +
           ggtitle("Air vs. Soil Temperature 2009-2011\n NEON Harvard Forest Field Site") +
            xlab("Air Temperature (C)") + ylab("Soil Temperature (C)") +
           theme(plot.title = element_text(lineheight=.8, face="bold",
                 size = 20)) +
           theme(text = element_text(size=18))

#create faceted panel
airSoilTemp_Plot + facet_wrap(~month_name, nc=3)

```


##Subset by Season - ADVANCED
Sometimes we want to group data by custom time periods. For example, we might
want to group by season. However, the definition of various seasons may vary by 
region which means we need to manually define each time period.

In the next section, we will add a season column to our data using a manually
defined query. Our field site is Harvard Forest (Massachusetts), located
in the northeastern portion of the United States. We can divide this 
region into 4 seasons as follows: 

 * Winter: December - February
 * Spring: March - May 
 * Summer: June - August
 * Fall: September - November 
 
In order to subset the data by season we will use the `dplyr` package.  We
can use the numeric month column that we added to our data earlier in this lesson.

```   {r subsetting-by-season-1}
#add month to data_frame - note we already performed this step above.
harMetDaily.09.11$month  <- month(harMetDaily.09.11$date)

#view head and tail of column
head(harMetDaily.09.11$month)
tail(harMetDaily.09.11$month)
```

We can use `mutate()` and a set of `ifelse` statements to create a new categorical
variable called `season` by grouping three months together. 

Within `dplyr` `%in%` is short-hand for "contained within". So the syntax:

`ifelse(month %in% c(12, 1, 2), "Winter",`

Can be read:

> if the `month` column value is 12 or 1 or 1, then assign the value "Winter"

Our `ifelse` statement ends with the following:

`ifelse(month %in% c(9, 10, 11), "Fall", "Error")`

We can translate this as:

> if the `month` column value is 9 or 10 or 11, then assign the value "Winter"

The last portion `, "Error"` tells `R` that if a `month` column value does not 
fall within any of the criteria laid out in previous `ifelse` statements, to 
assign the column the value of "Error". 


``` {r  subsetting-by-season-2}
harMetDaily.09.11 <- harMetDaily.09.11 %>% 
  mutate(season = 
           ifelse(month %in% c(12, 1, 2), "Winter",
           ifelse(month %in% c(3, 4, 5), "Spring",
           ifelse(month %in% c(6, 7, 8), "Summer",
           ifelse(month %in% c(9, 10, 11), "Fall", "Error")))))


#check to see if this worked
head(harMetDaily.09.11$month)
head(harMetDaily.09.11$season)
tail(harMetDaily.09.11$month)
tail(harMetDaily.09.11$season)
```

Now that we have a season column, we can plot our data by season!

```{r plot-by-season}

#recreate plot
airSoilTemp_Plot <- ggplot(harMetDaily.09.11, aes(airt, s10t)) +
           geom_point() +
           ggtitle("Air vs. Soil Temperature 2009-2011\n NEON Harvard Forest Field Site") +
            xlab("Air Temperature (C)") + ylab("Soil Temperature (C)") +
           theme(plot.title = element_text(lineheight=.8, face="bold",
                 size = 20)) +
           theme(text = element_text(size=18))

#run this code to plot the same plot as before but with one plot per season
airSoilTemp_Plot + facet_grid(. ~ season)
```

Note, that once again, we re-ran our `ggplot` code to make sure our new column
is recognized by `R`. We can experiment with various facet layouts next.

``` {r plot-by-season2}

# for a landscape orientation of the plots we change the order of arguments in
    #facet_grid():
airSoilTemp_Plot + facet_grid(season ~ .)



```

<div id="challenge" markdown="1">

##Challenge 

1. Convert the season column that we just created to a factor and organize the seasons
chronologically as follows: Winter, Spring, Summer, Fall. Create a new faceted 
plot that is 2 x 2 (2 columns of plots).
2. You can neatly plot multiple variables using facets as follows: 
`facet_grid(variable1 ~ variable2)`. Create a plot of air vs soil temperature
grouped by year AND season.
</div>

``` {r assigning-level-to-season, echo=FALSE  }

#create factor / assign levels
harMetDaily.09.11$season<- factor(harMetDaily.09.11$season, 
                                  level=c("Winter","Spring","Summer","Fall")) 

#check to make sure it worked
str(harMetDaily.09.11$season)

#rerun original par.precip code to incorporate the levels. 
airSoilTemp_Plot_season <- ggplot(harMetDaily.09.11,aes(prec, part)) +
         geom_point(na.rm=TRUE) +    #removing the NA values
        ggtitle("Seasonal Air vs Soil Temperature 2009-2011 \n NEON Harvard Forest Site") +
         theme(plot.title = element_text(lineheight=.8, face="bold",size = 20)) +
         theme(text = element_text(size=20)) +
         xlab("Total Precipitation (mm)") + ylab("Mean Total PAR")
           
#new facetted plots
airSoilTemp_Plot_season + facet_wrap(~ season, nc=2)

#new facetted plots
airSoilTemp_Plot_season + facet_grid(year ~ season)
```


<div id="challenge" markdown="1">

Use the `NEON-DS-Met-Time-Series/HARV/FisherTower-Met/hf001-04-monthly-m.csv` 
`.csv` file. This contains monthy average data for the NEON Harvard Forest field
site. Create a faceted plot of annual air temperature for each year of data
in the file (2001-2015)

* HINT: in this case, we will be converting a year-month field. To do this with
a base R date class, we need an associated day. We can add this using:

`as.Date(paste(met_monthly_HARV$date,"-01",sep=""))`

If we wanted we could use the `zoo` package to achieve this as follows:

`library(zoo)`
`as.Date(as.yearmon(met_monthly_HARV$date))`

Experiment on your own to figure out the methods that you prefer!

</div>

```{r plot-monthly-data, echo=FALSE }

met_monthly_HARV <- read.csv("NEON-DS-Met-Time-Series/HARV/FisherTower-Met/hf001-04-monthly-m.csv", stringsAsFactors = FALSE)

#convert to date time - add a day "01" to each date to support this in base R
met_monthly_HARV$date <- as.Date(paste(met_monthly_HARV$date,"-01",sep=""))

#add year
met_monthly_HARV$year <- year(met_monthly_HARV$date)

#add month
met_monthly_HARV$month <- factor(month(met_monthly_HARV$date))


#create plot
#rerun original par.precip code to incorporate the levels. 
long_term_temp <- ggplot(met_monthly_HARV,aes(month, airt)) +
         geom_point(na.rm=TRUE) +    #removing the NA values
        ggtitle("Air Temperature 2001-2015 \n NEON Harvard Forest Site") +
         theme(plot.title = element_text(lineheight=.8, face="bold",size = 20)) +
         theme(text = element_text(size=20)) +
         xlab("Total Precipitation (mm)") + ylab("Mean Total PAR")
           
#new facetted plots
long_term_temp + facet_wrap(~ year, nc=3)
```

***




